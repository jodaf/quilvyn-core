<!DOCTYPE html>

<!--
The Quilvyn Character Editor is Copyright 2021, James J. Hayes

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc., 59
Temple Place, Suite 330, Boston, MA 02111-1307 USA.
-->

<!-- This version of quilvyn.html is part of Quilvyn v2.2 -->

<html lang="en">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Quilvyn Program Window</title>

<script>
<!--

/*
 * If QUILVYN_HOME is the empty string, all Quilvyn sources are drawn from a
 * a local installation. Uncomment the second line below to draw the sources
 * from the reference installation instead.
 */
var QUILVYN_HOME = '';
// QUILVYN_HOME = 'http://www.jodaf.com/dnd/q2/';

var RULESETS = {};

if(window.location.search.indexOf('DEBUG') >= 0)
  window.DEBUG = true;

-->
</script>

<script src="plugins/plugins.js"></script>

<script>
<!--

/* Validation checking on RULESET defintions from plugins/plugins.js */
for(var rs in RULESETS) {
  var urlMissing = false;
  for(var attr in RULESETS[rs]) {
    if(!(['autoload', 'group', 'init', 'require', 'supplement', 'url'].includes(attr)))
      alert('Unknown attribute "' + attr + '" in definition of rule set "' + rs + '"');
    if(attr == 'url')
      urlMissing = false;
  }
  if(urlMissing)
    alert('Definition of rule set "' + rs + '" has no url attribute');
}

/**** Commands that load the Quilvyn software.  Do not modify. ****/

const CLOSE_TAG = '<' + '/' + 'script>\n';
const CORE_URLS = [
  QUILVYN_HOME + 'core/Expr.js',
  QUILVYN_HOME + 'core/Input.js',
  QUILVYN_HOME + 'core/ObjectViewer.js',
  QUILVYN_HOME + 'core/RuleEngine.js',
  QUILVYN_HOME + 'core/QuilvynUtils.js',
  QUILVYN_HOME + 'core/Quilvyn.js',
  QUILVYN_HOME + 'core/QuilvynRules.js'
];
const HELP_URL = QUILVYN_HOME + 'core/quilvyndoc.html';
const LOGO_URL = QUILVYN_HOME + 'core/quilvynlogodrop.png';
const LOGO_TAG =
  '<img src="' + LOGO_URL + '" style="height:75px; vertical-align:middle" alt="Quilvyn"/>';

// Work-around to support testing of Safari with local Quilvyn install
var STORAGE = null;
try {
  STORAGE = localStorage;
} catch(err) {
  // empty
}
if(STORAGE == null) {
  STORAGE = {
    'getItem':function(name) { return window.STORAGE[name]; },
    'removeItem':function(name) { delete window.STORAGE[name]; },
    'setItem':function(name,value) { window.STORAGE[name] = value; }
  };
}

for(var i = 0; i < CORE_URLS.length; i++) {
  document.write('<script src="' + CORE_URLS[i] + '">' + CLOSE_TAG);
}

for(var rs in RULESETS) {
  if(!RULESETS[rs].autoload)
    continue;
  url = RULESETS[rs].url;
  if(!url.includes('://'))
    url = QUILVYN_HOME + url;
  document.write('<script src="' + url + '">' + CLOSE_TAG);
}

function initRuleSet(funcName, ruleSet) {
  window[funcName](ruleSet);
  delete window.initRunning;
}

/*
 * Waits until the plugin for each rule set in #ruleSets# finishes loading,
 * then invokes its initialization function. After all have completed, invokes
 * the main Quilvyn function.
 */
function initializeRuleSets(ruleSets) {
  if(window.initRunning) {
    setTimeout
      ('initializeRuleSets([' + ruleSets.map(x => '"' + x + '"') + '])', 1000);
    return;
  }
  if(ruleSets.length == 0)
    return Quilvyn(mainWindow);
  var rs = ruleSets[0];
  var attrs = RULESETS[rs];
  var funcName = attrs.init || attrs.url.replace(/^.*\/|\.js$/g, '');
  if(window[funcName]) {
    ruleSets.shift();
    mainWindow.document.body.innerHTML +=
      '<p>Generating rules for ' + rs + '...</p>';
    window.initRunning = true;
    setTimeout('initRuleSet("' + funcName + '","' + rs + '")', 10);
  }
  setTimeout
    ('initializeRuleSets([' + ruleSets.map(x => '"' + x + '"') + '])', 1000);
};

/*
 * Waits for the user to press the Ok button, then loads the plugins for the
 * selected rule sets and any dependencies. Afterwards, calls initializeRuleSets
 * passing those the user selected.
 */
function loadPlugins() {

  if(!mainWindow.userPressedOkay) {
    setTimeout('loadPlugins()', 1000);
    return;
  }

  var selectedRuleSets =
    Object.keys(RULESETS).filter(
      rs => mainWindow.document.forms[0]['check' + rs].checked
    );
  if(selectedRuleSets.length == 0) {
    delete mainWindow.userPressedOkay;
    setTimeout('loadPlugins()', 1000);
    return;
  }

  mainWindow.document.body.innerHTML = '<p>Loading plugins...</p>';
  var pluginsLoaded =
    Object.keys(RULESETS).map(x => RULESETS[x].autoload ? RULESETS[x].url : '');
  for(var i = 0; i < selectedRuleSets.length; i++) {
    var rs = selectedRuleSets[i];
    var require = [rs];
    while(require.length > 0) {
      rs = require.pop();
      if(!pluginsLoaded.includes(RULESETS[rs].url)) {
        var scriptTag = document.createElement('script');
        var url = RULESETS[rs].url;
        pluginsLoaded.push(url);
        if(!url.includes('://'))
          url = QUILVYN_HOME + url;
        scriptTag.src = url;
        scriptTag.type = 'text/javascript';
        document.body.appendChild(scriptTag);
      }
      require = require.concat(RULESETS[rs].require || []);
      var supplement = RULESETS[rs].supplement;
      if(supplement && !selectedRuleSets.includes(supplement)) {
        selectedRuleSets.splice(i, 0, supplement);
        require.push(supplement);
      }
    }
  }

  STORAGE.setItem('QuilvynSelectedRuleSets', selectedRuleSets.join(','));
  initializeRuleSets(selectedRuleSets);

}

/* Displays the rule set selection window, then calls loadPlugins. */
function pickRuleSets() {

  var selectedRuleSets = [];
  try {
    selectedRuleSets = STORAGE.getItem('QuilvynSelectedRuleSets').split(',');
  } catch(err) {
    // empty
  }
  var currentGroup = '';
  var htmlBits = [
    '<html>',
    '<head>',
    '<title>Quilvyn Plugin Picker</title>',
    '</head><body bgcolor="wheat" background="Images/parchment.jpg">',
    LOGO_TAG + '<br/>',
    '<p>Select Quilvyn rule sets to use, then press Ok</p>',
    '<form name="frm">',
    '<table>'
  ];
  for(var rs in RULESETS) {
    var group = RULESETS[rs].group;
    if(group && group != currentGroup) {
      htmlBits.push('<tr><td>&nbsp;</td><th>' + group + '</th></tr>');
      currentGroup = group;
    }
    var options = 'autocomplete="off"' + (selectedRuleSets.includes(rs) ? ' checked="checked"' : '');
    htmlBits.push('<tr><td><input name="check' + rs + '" type="checkbox"' + options + '/></td><td>' + rs + (RULESETS[rs].comment || '') + '</td></tr>');
  }

  htmlBits.push(
    '</table>',
    '<br/>',
    '<input name="ok" type="button" value="Ok" onclick="window.userPressedOkay = true;"/>',
    '</form>',
    '</body>',
    '</html>'
  );
  mainWindow = window.frames[0];
  mainWindow.document.write(htmlBits.join('\n'));
  mainWindow.document.close();
  mainWindow.document.getElementsByName('ok')[0].focus();
  loadPlugins();

}

var mainWindow = null;

-->

</script>

<style>
  html, body, iframe {
    margin: 0px;
    padding: 0px;
    width: 100%;
    height: 100%;
    border: none;
  }
  html, body {
    overflow: hidden;
  }
  iframe {
    overflow: auto;
  }
</style>

</head>
<body onload='pickRuleSets();'>
  <iframe id="main" src="about:blank"></iframe>
</body>
</html>
