<!--
The Quilvyn Character Editor is Copyright 2020, James J. Hayes

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc., 59
Temple Place, Suite 330, Boston, MA 02111-1307 USA.
-->

<!-- This version of quilvyn.html is part of Quilvyn v2.alpha -->

<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Quilvyn Program Window</title>

<script>
<!--

/*
 * A few user preferences you may want to change: the background color for
 * Quilvyn's windows; the default character sheet format; the portion of a
 * common menu/character sheet that the menu occupies (Quilvyn opens separate
 * windows if this is outside the range 10..90); whether or not to warn when
 * you're about to lose changes made to the current character because you're
 * opening a new one.
 */
const BACKGROUND = 'wheat';
const DEFAULT_SHEET_STYLE = 'Standard';
const MENU_WIDTH_PERCENT = 30;
const WARN_ABOUT_DISCARD = true;

/*
 * If QUILVYN_HOME is the empty string, all Quilvyn sources are drawn from a
 * a local installation. Uncomment the second line below to draw the sources
 * from the reference installation instead.
 */
var QUILVYN_HOME = '';
// QUILVYN_HOME = 'http://www.jodaf.com/dnd/quilvyn/';

/*
 * Quilvyn incorporates the modules listed in PLUGINS as part of its initial
 * loading; you should uncomment those elements that you want to make part of
 * your Quilvyn installation and comment or delete the ones you don't want. If
 * any of the elements of PLUGINS begins with a question mark (e.g.,
 * '?SRD35NPC.js'), Quilvyn will prompt the user on start-up to ask whether to
 * include the rules from that module. This can be useful for rules that you
 * use occasionally but don't want always present. For example, you might want
 * to put a question mark before SRD35NPC.js for occasional use of the rules to
 * define NPCs. null elements are ignored, so the null value at the end of the
 * array makes it easy to add and remove elements without worrying about a
 * trailing comma.
 */
const PLUGINS = [
  'plugins/SRD35.js',
  '?plugins/SRD35NPC.js',
  '?plugins/SRD35Prestige.js',
  '?plugins/SRD35SpellPoints.js',
  // '?plugins/Eberron.js',
  // '?plugins/EberronPrestige.js',
  // '?plugins/LastAge.js',
  // '?plugins/LastAgePrestige.js',
  '?plugins/Pathfinder.js',
  '?plugins/PathfinderPrestige.js',
  // '?plugins/Realms.js',
  // '?plugins/RealmsPrestige.js',
  // '?plugins/FirstEdition.js',
  // '?plugins/SRD5E.js',
  // '?plugins/PHB5E.js',
  // '?plugins/HybridD20.js (in development)',
  null
];

/*
 * If this file defines a CustomizeQuilvyn function, Quilvyn calls it after
 * loading, allowing you to add custom behavior to the program. The default
 * implementation below can be used without modification or can be tailored for
 * your installation.
 */
function CustomizeQuilvyn() {

  // The first part of this implementation defines extensions to choices defined
  // by the SRD and Pathfinder plugins. Each extension includes a comment
  // that shows the information that needs to be supplied with each addition.
  var animalCompanions = {
    // Format 'name': 'stats', e.g.,
    // 'Babboon': 'Str=15 Dex=14 Con=12 Int=2 Wis=12 Cha=4 HD=1 Attack=2 AC=13 Dam=1d6+3 Size=M'
  };
  var deities = {
    // Format 'deity (alignment) Weapon=favored weapon Domain=domain', e.g.,
    // 'Glennor (NG Healing) Weapon=Quarterstaff Domain=Air,Animal,Healing'
  };
  var familiars = {
    // Format see animalCompanions, above
  };
  var feats = {
    // Format 'name':'Type=type Require=prerequisite Imply=prerequisite'
    // where type is one or more of General, Fighter, Item Creation, or
    // Metamagic, and Require and Imply list validation and sanity tests, e.g.,
  };
  var features = {
    // Format 'name':'Section=section Note=text'
    // where section is one of 'ability', 'combat', 'companion', 'feature', 'magic', or 'skill', e.g.,
    // 'Craft Talisman':'Section=magic Note="Create object to cast level 3 spell 1/dy"'
  };
  var languages = {
    // Format 'name':'', e.g.,
    // 'whale':''
  };
  var skills = {
    // Format 'name':'Ability=ability Class=class Untrained=Y/N' [Synergy=text]', e.g.,
    // 'herbalism':'Ability=intelligence Class=Druid,Ranger Untrained=N'
  };
  var spells = {
    // Format 'name':'School=school Description=text', e.g.,
    // 'Share Knowledge'"School=divination Description="R30\' Extract knowledge on specific subject from target (Will neg)"'
  };
  var weapons = {
    // Format 'name':Level=[0123] Category=Un|Si|1h|2h|R Damage=damage [Threat=int] [Crit=int] [Range=int], e.g.,,
    // 'Chakram':'Level=3 Category=R Damage=d6 Threat=19 Range=120'
    // 'Pike':'Level=2 Category=2h Damage=d8 Crit=3'
  };

  // The second part applies specific customizations to the rules.
  if(window.Pathfinder) {
    Object.assign(Pathfinder.ANIMAL_COMPANIONS, animalCompanions);
    Object.assign(Pathfinder.DEITIES, deities);
    Object.assign(Pathfinder.FAMILIARS, familiars);
    Object.assign(Pathfinder.FEATS, feats);
    Object.assign(Pathfinder.LANGUAGES, languages);
    Object.assign(Pathfinder.SKILLS, skills);
    Object.assign(Pathfinder.SPELLS, spells);
    Object.assign(Pathfinder.WEAPONS, weapons);
    if(window.location.search.indexOf('pf1e-35track') >= 0)
      Pathfinder.TRACKS.push('3.5');
  }
  for(var feat in feats) {
    if(feat.startsWith('Master Craftsman'))
      delete feats[feat];
  }
  if(window.SRD35) {
    Object.assign(SRD35.ANIMAL_COMPANIONS, animalCompanions);
    Object.assign(SRD35.DEITIES, deities);
    Object.assign(SRD35.FAMILIARS, familiars);
    Object.assign(SRD35.FEATS, feats);
    Object.assign(SRD35.LANGUAGES, languages);
    Object.assign(SRD35.SKILLS, skills);
    Object.assign(SRD35.SPELLS, spells);
    Object.assign(SRD35.WEAPONS, weapons);
  }
  if(window.LastAge) {
    if(window.location.search.indexOf('la-pf') >= 0)
      LastAge.USE_PATHFINDER = true;
  }

  // The third part invokes the initialization function of each selected plugin
  var selectedPlugins = [];
  try {
    selectedPlugins = STORAGE.getItem('QuilvynSelectedPlugins').split(',');
  } catch(err) {
    // empty
  }
  for(var i = 0; i < selectedPlugins.length; i++) {
    var funcName = selectedPlugins[i].replace(/.*\/|\.js/g, '');
    if(window[funcName]) {
      console.log('Invoke ' + funcName);
      window[funcName]();
      if(funcName == 'FirstEdition') {
        FirstEdition.USE_OSRIC_RULES = !FirstEdition.USE_OSRIC_RULES;
        window[funcName]();
      }
    } else {
      alert('Cannot call ' + funcName);
    }
  }

  if(window.SRD35SpellPoints != null) {
    if(window.SRD35 != null)
      SRD35SpellPoints.spellPointRules(SRD35.rules);
    if(window.Eberron != null)
      SRD35SpellPoints.spellPointRules(Eberron.rules);
    if(window.Pathfinder != null)
      SRD35SpellPoints.spellPointRules(Pathfinder.rules);
    if(window.Realms != null)
      SRD35SpellPoints.spellPointRules(Realms.rules);
  }

}

/**** Commands that load the Quilvyn software.  Do not modify. ****/

const CLOSE_TAG = '<' + '/' + 'script>\n';
const CORE_URLS = [
  QUILVYN_HOME + 'core/Input.js',
  QUILVYN_HOME + 'core/ObjectViewer.js',
  QUILVYN_HOME + 'core/RuleEngine.js',
  QUILVYN_HOME + 'core/QuilvynUtils.js',
  QUILVYN_HOME + 'core/Quilvyn.js',
  QUILVYN_HOME + 'core/QuilvynRules.js'
];
const HELP_URL = QUILVYN_HOME + 'core/quilvyndoc.html';
const LOGO_URL = QUILVYN_HOME + 'core/quilvyn.gif';

// Work-around to support testing of IE/Edge with local Quilvyn install
var STORAGE = null;
try {
  STORAGE = localStorage;
} catch(err) {
  // empty
}
if(STORAGE == null) {
  STORAGE = {
    'getItem':function(name) { return window.STORAGE[name]; },
    'removeItem':function(name) { delete window.STORAGE[name]; },
    'setItem':function(name,value) { window.STORAGE[name] = value; }
  };
}

for(var i = 0; i < CORE_URLS.length; i++) {
  document.write('<script src="' + CORE_URLS[i] + '">' + CLOSE_TAG);
}

var pluginPopup = null;

for(var i = 0; i < PLUGINS.length; i++) {
  if(PLUGINS[i] == null)
    continue;
  if(!PLUGINS[i].startsWith('?')) {
    var url = QUILVYN_HOME + PLUGINS[i].replace(/ *\(.*\)/g, '');
    document.write('<script src="' + url + '">' + CLOSE_TAG);
  }
  else if(pluginPopup == null) {
    pluginPopup = window.open('', '__plugins', 'height=750,width=750,menubar,resizable,scrollbars,toolbar');
  }
}

if(pluginPopup != null) {
  pluginPopup.document.write(
    '<html><head><title>Quilvyn Plugin Selection</title></head>\n' +
    '<body bgcolor="' + BACKGROUND + '">\n' +
    '<img src="' + LOGO_URL + ' "/><br/>\n' +
    '<h2>Select Quilvyn plugins to use</h2>\n' +
    '<form name="frm"><table>\n'
  );
  var selectedPlugins = [];
  try {
    selectedPlugins = STORAGE.getItem('QuilvynSelectedPlugins').split(',');
  } catch(err) {
    // empty
  }
  for(var i = 0; i < PLUGINS.length; i++) {
    if(PLUGINS[i] == null)
      continue;
    var url = PLUGINS[i].replace(/ .*|\?/g, '');
    var label = PLUGINS[i].replace(/.*\/|\.js/g, '');
    label = label.replace(/([a-z0-9])(?=[A-Z])/g, '$1 ');
    var options = !PLUGINS[i].startsWith('?') ? ' checked=true disabled=true' :
                  selectedPlugins.indexOf(url) > 0 ? ' checked=true' : '';
    pluginPopup.document.write('<tr><td><input name="plugin' + i + '" type="checkbox"' + options + '/></td><td>' + label + '</td></tr>\n');
  }
  pluginPopup.document.write(
    '</table></form>\n' +
    '<form>\n' +
    '<input type="button" value="Ok" autofocus="y" onclick="window.okay = true;"/>\n' +
    '</form></body></html>\n'
  );
  pluginPopup.document.close();
}

function LoadPlugins() {
  if(pluginPopup != null && !pluginPopup.closed && !pluginPopup.okay) {
    setTimeout('LoadPlugins()', 1000);
    return;
  }
  var selectedPlugins =
    PLUGINS.filter(item => item != null && !item.startsWith('?'));
  if(pluginPopup != null && !pluginPopup.closed) {
    selectedPlugins = [];
    for(var i = 0; i < PLUGINS.length; i++) {
      if(PLUGINS[i] != null &&
         pluginPopup.document.forms[0]['plugin' + i].checked)
        selectedPlugins.push(PLUGINS[i]);
    }
  }
  for(var i = 0; i < selectedPlugins.length; i++) {
    selectedPlugins[i] = selectedPlugins[i].replace(/ .*/, '');
    if(selectedPlugins[i].startsWith('?')) {
      selectedPlugins[i] = selectedPlugins[i].replace('?', '');
      var scriptTag = document.createElement('script');
      scriptTag.src = QUILVYN_HOME + selectedPlugins[i];
      scriptTag.type = 'text/javascript';
      document.body.appendChild(scriptTag);
    }
  }
  STORAGE.setItem('QuilvynSelectedPlugins', selectedPlugins.join(','));
  if(!pluginPopup.closed)
    pluginPopup.close();
  StartQuilvyn();
}

function StartQuilvyn() {
  var selectedPlugins = STORAGE.getItem('QuilvynSelectedPlugins').split(',');
  for(var i = 0; i < selectedPlugins.length; i++) {
    var funcName = selectedPlugins[i].replace(/.*\/|\.js/g, '');
    if(window[funcName] == null) {
      setTimeout('StartQuilvyn()', 1000);
      return;
    }
  }
  Quilvyn();
}

-->
</script>

</head>
<body onload="document.bgColor=BACKGROUND;LoadPlugins();">

<script>
  document.write('<img src="' + LOGO_URL + '"/><br/>');
</script>
Quilvyn is running from this window.  Please leave it open until you are done
using Quilvyn.

</body>
</html>
