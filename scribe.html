<!--
The Scribe Character Editor is Copyright 2019, James J. Hayes

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along
with this program; if not, write to the Free Software Foundation, Inc., 59
Temple Place, Suite 330, Boston, MA 02111-1307 USA.
-->

<!-- This version of scribe.html is part of Scribe v1.5. -->

<html>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Scribe Program Window</title>

<script>
<!--

/*
 * A few user preferences you may want to change: the background color for
 * Scribe's windows; the default character sheet format; the portion of a
 * common menu/character sheet that the menu occupies (Scribe opens separate
 * windows if this is outside the range 10..90); whether or not to warn when
 * you're about to lose changes made to the current character because you're
 * opening a new one.
 */
const BACKGROUND = 'wheat';
const DEFAULT_SHEET_STYLE = 'Standard';
const MENU_WIDTH_PERCENT = 30;
const WARN_ABOUT_DISCARD = true;

/*
 * If SCRIBE_HOME is the empty string, all Scribe sources are drawn from a
 * a local installation. Uncomment the second line below to draw the sources
 * from the reference installation instead.
 */
var SCRIBE_HOME = '';
// SCRIBE_HOME = 'http://www.jodaf.com/dnd/scribe/';

/*
 * Scribe incorporates the modules listed in PLUGINS as part of its initial
 * loading; you should uncomment those elements that you want to make part of
 * your Scribe installation and comment or delete the ones you don't want. If
 * any of the elements of PLUGINS begins with a question mark (e.g.,
 * '?SRD35NPC.js'), Scribe will prompt the user on start-up to ask whether to
 * include the rules from that module. This can be useful for rules that you
 * use occasionally but don't want always present. For example, you might want
 * to put a question mark before SRD35PC.js for occasional use of the rules to
 * define NPCs. null elements are ignored, so the null value at the end of the
 * array makes it easy to add and remove elements without worrying about a
 * trailing comma.
 */
const PLUGINS = [
  'srd35/SRD35.js',
  '?srd35/SRD35NPC.js',
  '?srd35/SRD35Prestige.js',
  'srd35/Experience.js',
  'srd35/SRD35SpellDescriptions.js',
  'srd35/CustomSpellPoints.js',
  '?plugins/Eberron.js',
  '?plugins/EberronPrestige.js',
  '?plugins/LastAge.js',
  '?plugins/LastAgePrestige.js',
  '?plugins/Pathfinder.js',
  '?plugins/PathfinderPrestige.js',
  '?plugins/Realms.js',
  '?plugins/RealmsPrestige.js',
  '?plugins/FirstEdition.js',
  '?plugins/HybridD20.js (alpha)',
  '?plugins/FiveE.js (alpha)',
  null
];

/*
 * If this file defines a CustomizeScribe function, Scribe calls it after
 * loading, allowing you to add custom behavior to the program.  See
 * scribedoc.html for details.  The default implementation below can be used
 * without modification or can be tailored for your installation.
 */
function CustomizeScribe() {
  // The first part of this implementation provides an easy way to define
  // subfeats, subskills (e.g., Weapon Focus (Longbow), Craft (Alchemy))
  // and goodies to the SRD35 and Pathfinder rule sets.  Each element of the
  // subfeats/subskills variables gives a feat/skill and a slash-delimited list
  // of subfeat targets.  Modify the values in each list to determine which
  // subfeats/subskills are defined in your Scribe installation.
  // Scribe automatically generates rules for goodies with one of these forms:
  //   Masterwork <armor>|<weapon>
  //   <armor>|<weapon> +<amount>
  //   <item> Of <skill>|<ability>|Protection +<amount>
  var subfeats = {
    'Greater Weapon Focus':'',
    'Greater Weapon Specialization':'',
    'Improved Critical':'Dwarven Waraxe/Longbow/Longsword',
    'Master Craftsman':'', // Pathfinder only
    'Skill Focus':'',
    'Weapon Focus':'Dwarven Waraxe/Longbow/Longsword',
    'Weapon Proficiency':'Simple',
    'Weapon Specialization':'Dwarven Waraxe/Longbow/Longsword'
  };
  var subskills = {
    'Craft':'Alchemy',
    'Profession':''
  };
  var goodies = [
  ];
  // The second part applies specific customizations to the rules.
  if(window.Pathfinder) {
    Object.assign(Pathfinder.SUBFEATS, subfeats);
    Object.assign(Pathfinder.SUBSKILLS, subskills);
  }
  delete subfeats['Master Craftsman'];
  if(window.SRD35) {
    Object.assign(SRD35.SUBFEATS, subfeats);
    Object.assign(SRD35.SUBSKILLS, subskills);
    SRD35.GOODIES = SRD35.GOODIES.concat(goodies);
  }
  if(window.Experience != null) {
    if(window.SRD35 != null)
      Experience.experienceRules(SRD35.rules);
    if(window.Eberron != null)
      Experience.experienceRules(Eberron.rules);
    if(window.LastAge != null)
      Experience.experienceRules(LastAge.rules);
    if(window.Pathfinder != null)
      Experience.experienceRules(Pathfinder.rules);
    if(window.Realms != null)
      Experience.experienceRules(Realms.rules);
  }
  if(window.CustomSpellPoints != null) {
    if(window.SRD35 != null)
      CustomSpellPoints.spellPointRules(SRD35.rules);
    if(window.Eberron != null)
      CustomSpellPoints.spellPointRules(Eberron.rules);
    if(window.Pathfinder != null)
      CustomSpellPoints.spellPointRules(Pathfinder.rules);
    if(window.Realms != null)
      CustomSpellPoints.spellPointRules(Realms.rules);
  }
  if(window.SRD35SpellDescriptions != null) {
    if(window.SRD35 != null)
      SRD35SpellDescriptions.spellRules(SRD35.rules);
    if(window.Eberron != null)
      SRD35SpellDescriptions.spellRules(Eberron.rules, null, Object.assign({}, SRD35SpellDescriptions.descriptions, Eberron.spellsDescriptions));
    if(window.LastAge != null)
      SRD35SpellDescriptions.spellRules(LastAge.rules, null, Object.assign({}, SRD35SpellDescriptions.descriptions, LastAge.spellsDescriptions));
    if(window.Pathfinder != null)
      SRD35SpellDescriptions.spellRules(Pathfinder.rules);
    if(window.Realms != null)
      SRD35SpellDescriptions.spellRules(Realms.rules, null, Object.assign({}, SRD35SpellDescriptions.descriptions, Realms.spellsDescriptions));
  }
}

/**** Commands that load the Scribe software.  Do not modify. ****/

const CLOSE_TAG = '<' + '/' + 'script>\n';
const CORE_URLS = [
  SCRIBE_HOME + 'core/Input.js',
  SCRIBE_HOME + 'core/ObjectViewer.js',
  SCRIBE_HOME + 'core/RuleEngine.js',
  SCRIBE_HOME + 'core/ScribeUtils.js',
  SCRIBE_HOME + 'core/Scribe.js',
  SCRIBE_HOME + 'core/ScribeRules.js'
];
const HELP_URL = SCRIBE_HOME + 'core/scribedoc.html';
const LOGO_URL = SCRIBE_HOME + 'core/scribe.gif';

for(var i = 0; i < CORE_URLS.length; i++) {
  document.write('<script src="' + CORE_URLS[i] + '">' + CLOSE_TAG);
}

var pluginPopup = null;

for(var i = 0; i < PLUGINS.length; i++) {
  if(PLUGINS[i] == null)
    continue;
  if(!PLUGINS[i].startsWith('?')) {
    var url = SCRIBE_HOME + PLUGINS[i].replace(/ *\(.*\)/g, '');
    document.write('<script src="' + url + '">' + CLOSE_TAG);
  }
  else if(pluginPopup == null) {
    pluginPopup = window.open('', '__plugins', 'height=750,width=750,menubar,resizable,scrollbars,toolbar');
  }
}

if(pluginPopup != null) {
  pluginPopup.document.write(
    '<html><head><title>Select Scribe Plugins to Use</title></head>\n' +
    '<body bgcolor="' + BACKGROUND + '">\n' +
    '<img src="' + LOGO_URL + ' "/><br/>\n' +
    '<h2>Select Scribe Plugins to Use</h2>\n' +
    '<form name="frm"><table>\n'
  );
  var storedDefaultRules = null;
  try {
    storedDefaultRules = localStorage.getItem('ScribeDefaultRules');
  } catch(err) {
    // empty
  }
  if(storedDefaultRules == null)
    storedDefaultRules = '';
  for(var i = 0; i < PLUGINS.length; i++) {
    if(PLUGINS[i] == null)
      continue;
    var label = PLUGINS[i].replace(/.*\/|\.js|\?/g, '');
    label = label.replace(/([a-z0-9])(?=[A-Z])/g, '$1 ');
    var options = !PLUGINS[i].startsWith('?') ? ' checked=true disabled=true' :
                  storedDefaultRules.indexOf(label) > 0 ? ' checked=true' : '';
    pluginPopup.document.write('<tr><td><input name="plugin' + i + '" type="checkbox"' + options + '/></td><td>' + label + '</td></tr>\n');
  }
  pluginPopup.document.write(
    '</table></form>\n' +
    '<form>\n' +
    '<input type="button" value="Ok" onclick="window.close();"/>\n' +
    '</form></body></html>\n'
  );
  pluginPopup.document.close();
}

function LoadPlugins() {
  if(pluginPopup != null && !pluginPopup.closed) {
    setTimeout('LoadPlugins()', 1000);
    return;
  }
  var storedDefaultRules = '';
  for(var i = 0; i < PLUGINS.length; i++) {
    if(PLUGINS[i] == null)
      continue;
    if(pluginPopup.document.forms[0]['plugin' + i].checked) {
      if(PLUGINS[i].startsWith('?')) {
        var scriptTag = document.createElement('script');
        scriptTag.src = SCRIBE_HOME + PLUGINS[i].replace(/ *\(.*\)|\?/g, '');
        scriptTag.type = 'text/javascript';
        scriptTag.onload = new Function('window["plugin' + i + 'Loaded"]=true;');
        document.body.appendChild(scriptTag);
      }
      var label = PLUGINS[i].replace(/.*\/|\.js|\?/g, '');
      label = label.replace(/([a-z0-9])(?=[A-Z])/g, '$1 ');
      storedDefaultRules += label;
    }
  }
  try {
    localStorage.setItem('ScribeDefaultRules', storedDefaultRules);
  } catch(err) {
    // empty
  }
  StartScribe();
}

function StartScribe() {
  for(var i = 0; i < PLUGINS.length; i++) {
    if(PLUGINS[i] == null)
      continue;
    if(PLUGINS[i].startsWith('?') &&
       pluginPopup.document.forms[0]['plugin' + i].checked &&
       !window['plugin' + i + 'Loaded']) {
      setTimeout('StartScribe()', 1000);
      return;
    }
  }
  for(var i = 0; i < PLUGINS.length; i++) {
    if(PLUGINS[i] == null)
      continue;
    if(!PLUGINS[i].startsWith('?') ||
       pluginPopup.document.forms[0]['plugin' + i].checked) {
      var funcName = PLUGINS[i].replace(/.*\/|\.js|\?| *\(.*\)/g, '');
      if(window[funcName]) {
        console.log('Invoke ' + funcName);
        window[funcName]();
        if(funcName == 'FirstEdition') {
          FirstEdition.USE_OSRIC_RULES = !FirstEdition.USE_OSRIC_RULES;
          window[funcName]();
        }
      } else {
        alert('Cannot call ' + funcName);
      }
    }
  }
  Scribe();
}

-->
</script>

</head>
<body onload="document.bgColor=BACKGROUND;LoadPlugins();">

<script>
  document.write('<img src="' + LOGO_URL + '"/><br/>');
</script>
Scribe is running from this window.  Please leave it open until you are done
using Scribe.

</body>
</html>
